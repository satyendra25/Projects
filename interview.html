<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    

    <script>
        const user = {name: "Saten", age: 32, id: 123};

        Object.defineProperties(user,{writable:false});
        user.id = 3211;
        console.log(user.id);
    </script>
</body>
</html>
<section>
    import express from "express";
import bodyParser from "body-parser";
import mongoose from "mongoose";
import session from "express-session";
import passport from "passport";
import passportLocalMongoose from "passport-local-mongoose";
import 'dotenv/config'

const app = express();
const port = 5000;

mongoose.connect('mongodb://localhost:27017/tweetDB').then(() => console.log("Connected to mongodb"));

app.use(express.static('public'))
app.set('view engine', 'ejs')
app.use(bodyParser.urlencoded({ extended: false }));

app.use(session({
    secret: process.env.SECRET,
    resave: false,
    saveUninitialized: false
}));

app.use(passport.initialize());
app.use(passport.session());

const userSchema = new mongoose.Schema({
    name: String,
    username: String,
    password: String 
});

userSchema.plugin(passportLocalMongoose);

const User = new mongoose.model('User', userSchema);

passport.use(User.createStrategy());


passport.serializeUser(User.serializeUser());
passport.deserializeUser(User.deserializeUser());

app.get('/', (req, res) => {
    res.render('twitter/index')
});

app.get('/login', (req, res) => {
    const message = req.query.message;
    res.render('twitter/login', { message})
});

app.post('/login', (req, res) => {
    const user = new User({
        username: req.body.username,
        password: req.body.password
    });

    req.login(user, function(err) {
        if(err) {
            console.log(err);
            res.redirect("/login");
        } else {
            passport.authenticate("local", { 
                successRedirect: 'tweets22', 
                // failureRedirect: 'tweets22'
            })
                (req, res, function() {
                res.redirect("tweets22")
            })
        }
    });
});

app.get('/register22', (req, res) => {
    res.render('twitter/register22')
});

app.post('/register22', (req, res) => {
    User.register({username: req.body.username},
         req.body.password,
          function(err, user) {
        if(err) {
            console.log(err)
            res.redirect("/register22");
        } else {
            passport.authenticate("local")(req, res, function() {
                // console.log("not working")
                res.redirect("/tweets22")
            })
        }
    });
});

app.get("/tweets22", (req, res) => {
    if (req.isAuthenticated()) {
      User.findOne(req.user._id).then((data) => {
        if (data) {
          res.render("twitter/tweets22", { user: data });
        }
      });
    } else {
      res.redirect("login");
    }
  });

// app.get('/tweets22', (req, res) => {
//     if (req.isAuthenticated()) {
//         User.findOne(req.user._id).then((user) => {
//         if (user) {
//             res.render('twitter/tweets22', {user: user});
//         } else {
//             console.log("User not found");
//         }
//     })
//     .catch((err) => {
//         console.error("Error fetching user:", err);
//     });

//     } else {
//         res.redirect("login");
//     }
// });


app.get('/logout', (req, res) => {
    req.logout(function(err) {
        if(err) {
            console.log(err)
        }
    });
    res.redirect("/");
});

app.listen(port, () => {
    console.log("My first express project is live");
})
</section>